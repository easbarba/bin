#!/usr/bin/env bash

# DEBUG SETTINGS
set -euo pipefail

BECOME=false
DISTRO="$(awk '/^NAME=/ { split($0,a,"="); print a[2] }' /etc/os-release)"

# * CHECKER
DEPS=(bash sudo zae qas rsync)
s-checkdeps "${DEPS[@]}"

# * OPTIONS
print_usage() {
    printf "Usage:
    -s      skip become tasks
"
}

while getopts ':b' flag; do
    case "${flag}" in
        b) BECOME=true ;;
        *)
            print_usage
            exit 1
            ;;
    esac
done

# * MAIN
# ** SYSTEM
s-echo "Upgrading $DISTRO system packages."

[[ $BECOME != true && -x $(command -v zae) ]] && zae update && zae upgrade

# ** FOREIGN
s-distro-guix
s-distro-flatpak

# ** DEVELOPMENT
s-dev-emacs
s-dev-ruby
s-dev-java
s-dev-scheme
s-dev-python
s-ops-containers

# * USER
if [[ -x $(command -v qas) ]]; then
    qas --grab
    qas --archive bin,lar,annotations # TODO: save to usb-stick
fi

# * USB-STICK
rsync -vhazrtP --ignore-existing /da/livros "/media/$USER/MOAR/"
